# app.py

## 背景說明

這是一個完整的 環保法規查詢小助手 Web 應用程式，使用 Python 的 Streamlit 建立，整合了 Redis、ElasticSearch、Llama-index 和多種自訂模組，提供使用者互動式的法規檢索體驗。以下為此程式的設計說明：

## 程式說明

### 一、主要功能模組概覽

1. 主畫面呈現與狀態管理

- 使用 Streamlit 的 st.session_state 管理使用者選項、已載入資料、登入資訊與歷史記錄。
- 使用者可透過「下拉選單」、「名稱搜尋」、「模糊篩選」、「曾經開啟」、「直接開啟」等多種方式載入特定法規。

2. 法規分類與選擇邏輯

- 使用 `define_fields(tag)` 動態產生`法規領域→主類別→子類別→法規名稱` 的層級選單。
- 搭配 `laws_dict()` 取得分類結構，並使用 `reverse_lookup` 等方法反推選單位置。

3. 搜尋功能

- 關鍵字搜尋：選擇一組或多組關鍵詞，搜尋相關法規。
- 全文搜尋：使用 `redis_search` 檢索指定關鍵字出現的條文，並顯示結果。

4. 法規條文顯示(左側欄)

- 顯示所選法規的基本資訊（名稱、日期、摘要）。
- 提供按鈕控制條文收合與展開。

5. LLM 問答功能

- 使用 LLM 模型針對選定法規資料進行自然語言問答。
- 啟動 `router_engine`，以使用者名稱與法規作為初始化條件。

6. 歷史紀錄與個人化

- 自動記錄每次查詢行為到 `data/{username}/search_his.log`。
- 根據登入名稱載入個人歷史紀錄與偏好。

### 二、依賴模組說明

自訂模組：

- `router_engine`: 啟用與 Llama 模型的互動問答邏輯。
- `extrat_kw`: 文字分析與關鍵詞抽取。
- `redis_es`: Redis + `redis_search` 資料索引與檢索。
- `util_k`: 系統工具（如複製文字、取得 cookie 使用者資訊）。
- `redis_srch`: 用於建立 `redis_search` 索引、搜尋條文。


### 三、使用流程圖概述

[使用者進入系統]
        ↓
[選擇法規方式]
→ 下拉選單 / 名稱搜尋 / 模糊搜尋 / 歷史記錄
        ↓
[顯示法規資訊]
→ 條文內容 + 關鍵字 / 全文搜尋
        ↓
[互動式問答（Llama）]
→ 自然語言詢問條文內容

### 四、設計亮點

- 多種篩選方式（靜態選單 + 動態模糊查詢）。
- 結合 Redis、RedisSearch 提供高速檢索。
- 使用者歷史個人化推薦功能。
- 使用 Llama 大語言模型進行互動式問答。

